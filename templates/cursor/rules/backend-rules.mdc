---
description: バックエンド開発用のルール
globs: ["backend/**/*", "server/**/*", "api/**/*"]
alwaysApply: false
---

# Backend Rules

このルールは、バックエンドディレクトリ（`backend/`、`server/`、`api/`）のコードに自動的に適用されます。

## バックエンドアーキテクチャ

### レイヤードアーキテクチャ

- **Controller層**: リクエストの受付とレスポンスの返却
- **Service層**: ビジネスロジックの実装
- **Repository層**: データアクセスの抽象化
- **Model層**: データモデルの定義

### ディレクトリ構造

```
backend/
  controllers/     # リクエストハンドラー
  services/        # ビジネスロジック
  repositories/    # データアクセス
  models/          # データモデル
  middleware/      # ミドルウェア
  utils/           # ユーティリティ
```

## データベース

### クエリ最適化

- N+1問題を避ける（Eager Loading、バッチ読み込み）
- インデックスを適切に使用
- トランザクションを適切に管理
- 接続プールを適切に設定

### マイグレーション

- マイグレーションファイルは段階的に作成
- ロールバック可能なマイグレーション
- 本番環境でのマイグレーションは慎重に実行

## エラーハンドリング

### エラーレスポンス

- 統一されたエラーレスポンス形式
- 適切なHTTPステータスコード
- エラーログにコンテキスト情報を含める

### 例外処理

- カスタム例外クラスを作成
- 例外の階層構造を定義
- グローバル例外ハンドラーで処理

## セキュリティ

### 認証・認可

- JWTトークンを使用した認証
- ロールベースアクセス制御（RBAC）
- パスワードはハッシュ化して保存

### 入力バリデーション

- すべての入力パラメータをバリデーション
- SQLインジェクション対策
- XSS対策

## パフォーマンス

### キャッシング

- 頻繁にアクセスされるデータはキャッシュ
- キャッシュの無効化戦略を定義
- Redisなどのキャッシュサーバーを活用

### 非同期処理

- 重い処理は非同期で実行
- ジョブキューを使用
- バックグラウンドジョブで処理

## ロギング

- 構造化ログ（JSON形式）
- ログレベルを適切に設定
- 機密情報はログに含めない
- ログローテーションを設定

## テスト

- 単体テスト: Service層とRepository層
- 統合テスト: APIエンドポイント
- モック: 外部依存関係（DB、API）をモック
