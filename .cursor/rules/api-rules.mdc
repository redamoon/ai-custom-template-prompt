---
description: API関連のコードに適用されるルール
globs: ["**/api/**/*", "**/routes/**/*", "**/controllers/**/*", "**/endpoints/**/*"]
alwaysApply: false
---

# API Rules

このルールは、API関連のコード（`api/`、`routes/`、`controllers/`、`endpoints/`ディレクトリ）に自動的に適用されます。

## RESTful API 設計

### HTTPメソッドの適切な使用

- **GET**: リソースの取得（副作用なし）
- **POST**: リソースの作成
- **PUT**: リソースの完全な更新
- **PATCH**: リソースの部分的な更新
- **DELETE**: リソースの削除

### エンドポイントの命名規則

- リソース名は複数形を使用（例: `/users`、`/products`）
- ネストされたリソースは階層的に表現（例: `/users/:userId/posts`）
- 動詞は避け、名詞を使用（例: `/users` ではなく `/getUsers` は避ける）

### ステータスコード

- **200 OK**: 成功したGET、PUT、PATCH
- **201 Created**: 成功したPOST
- **204 No Content**: 成功したDELETE
- **400 Bad Request**: 不正なリクエスト
- **401 Unauthorized**: 認証が必要
- **403 Forbidden**: 権限がない
- **404 Not Found**: リソースが見つからない
- **500 Internal Server Error**: サーバーエラー

## リクエストとレスポンス

### リクエストバリデーション

- すべての入力パラメータをバリデーション
- バリデーションエラーは明確なメッセージを返す
- 型安全性を確保（TypeScriptの型定義を使用）

### レスポンス形式

- 一貫したレスポンス形式を使用
- エラーレスポンスは統一された形式で返す
- ページネーションは標準的な形式で実装

### レスポンスの例

```typescript
// 成功レスポンス
{
  "data": { ... },
  "meta": { ... }
}

// エラーレスポンス
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input",
    "details": [ ... ]
  }
}
```

## 認証と認可

### 認証

- JWTトークンを使用した認証
- トークンの有効期限を適切に設定
- リフレッシュトークンでセキュアに更新

### 認可

- ロールベースアクセス制御（RBAC）
- リソースレベルでの権限チェック
- 認可エラーは403を返す

## エラーハンドリング

### エラーミドルウェア

- 統一されたエラーハンドリングミドルウェアを使用
- エラーログに適切なコンテキスト情報を含める
- 本番環境では詳細なエラー情報を隠す

### エラーハンドリングの例

```typescript
try {
  // API処理
} catch (error) {
  if (error instanceof ValidationError) {
    return res.status(400).json({ error: error.message });
  }
  logger.error('API Error', { error, context });
  return res.status(500).json({ error: 'Internal server error' });
}
```

## レート制限

- APIレート制限を実装
- ユーザーごと、IPごとに制限を設定
- レート制限超過時は429ステータスを返す

## APIバージョニング

- URLパスでバージョン管理（例: `/api/v1/users`）
- 後方互換性を維持
- 非推奨APIは適切に通知

## ドキュメント

### APIドキュメント

- OpenAPI/Swagger仕様でAPIを定義
- エンドポイントごとに説明を記載
- リクエスト/レスポンスの例を提供

### コードコメント

- エンドポイントの目的を説明
- パラメータの説明を記載
- エラーケースを文書化

## セキュリティ

### 入力サニタイズ

- SQLインジェクション対策（パラメータ化クエリ）
- XSS対策（出力のエスケープ）
- CSRF対策（トークンの検証）

### ヘッダー設定

- 適切なCORS設定
- セキュリティヘッダーの設定（X-Content-Type-Options、X-Frame-Optionsなど）
- Content-Typeの検証

## パフォーマンス

### キャッシング

- 適切なキャッシュヘッダーを設定
- 静的リソースは長期キャッシュ
- 動的リソースは適切なTTLを設定

### データベースクエリ

- N+1問題を避ける
- インデックスを適切に使用
- ページネーションを実装

## ロギング

- すべてのAPIリクエストをログに記録
- エラーは詳細なコンテキストと共にログ
- パフォーマンスメトリクスを記録
