name: Publish Package

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for npm Trusted Publishing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Extract and validate version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # セマンティックバージョニング形式を検証（例: 1.2.3）
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease or X.Y.Z+build"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update package.json version
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.get_version.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Publish to GitHub Packages (Private)
        continue-on-error: true
        run: |
          echo "@redamoon:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc
          npm publish --registry=https://npm.pkg.github.com || {
            echo "GitHub Packages publish failed (version may already exist)"
            echo "Continuing with npm publish..."
          }
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js for npm (Trusted Publishing)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          # Trusted Publishingを使用する場合はalways-authは不要

      - name: Publish to Public npm (Trusted Publishing)
        continue-on-error: true
        env:
          # NODE_AUTH_TOKENをクリアしてTrusted Publishingを使用
          NODE_AUTH_TOKEN: ''
        run: |
          # GitHub Packages用の.npmrcを確実に削除
          rm -f .npmrc
          # 環境変数からNODE_AUTH_TOKENを削除（Trusted Publishingを使用するため）
          unset NODE_AUTH_TOKEN
          # package.jsonを一時的に変更してPublic npm用に設定
          cp package.json package.json.backup
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.name = 'ai-custom-template-prompt';
            delete pkg.publishConfig;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          # パッケージが存在するか確認
          echo "Checking if package exists..."
          npm view ai-custom-template-prompt@${{ steps.get_version.outputs.version }} 2>&1 || echo "Version ${{ steps.get_version.outputs.version }} does not exist yet"
          # Trusted Publishingを使用して公開（--provenanceフラグで出所証明を生成）
          echo "Publishing to npm with Trusted Publishing..."
          npm publish --provenance --access public || {
            echo "Publish failed. Error details:"
            echo "This might be due to:"
            echo "1. Trusted Publishing not properly configured in GitHub repository settings"
            echo "2. Package name or version conflict"
            echo "3. Authentication issues with npm Trusted Publishing"
            echo ""
            echo "To fix Trusted Publishing:"
            echo "1. Go to https://www.npmjs.com/package/ai-custom-template-prompt"
            echo "2. Click 'Settings' (or go to Publishing/Access section)"
            echo "3. Find 'Trusted Publisher' section"
            echo "4. Configure:"
            echo "   - Provider: GitHub Actions"
            echo "   - Organization or user: redamoon"
            echo "   - Repository: ai-custom-template-prompt"
            echo "   - Workflow filename: publish.yml (with .yml extension)"
            echo "   - Environment name: (leave blank if not using)"
            echo "5. Save the configuration"
            exit 1
          }
          echo "Successfully published to npm!"
          mv package.json.backup package.json

